<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Constant Folding â€¢ rco</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Constant Folding">
<meta property="og:description" content="rco">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rco</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Optimizers
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/opt-common-subexpr.html">Common Subexpression Elimination</a>
    </li>
    <li>
      <a href="../articles/opt-constant-folding.html">Constant Folding</a>
    </li>
    <li>
      <a href="../articles/opt-constant-propagation.html">Constant Propagation</a>
    </li>
    <li>
      <a href="../articles/opt-dead-code.html">Dead Code Elimination</a>
    </li>
    <li>
      <a href="../articles/opt-dead-expr.html">Dead Expression Elimination</a>
    </li>
    <li>
      <a href="../articles/opt-dead-store.html">Dead Store Elimination</a>
    </li>
    <li>
      <a href="../articles/opt-loop-invariant.html">Loop-invariant Code Motion</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/contributing-an-optimizer.html">Contributing an Optimizer</a>
    </li>
    <li>
      <a href="../articles/potential-optimizers.html">Potential Optimizers</a>
    </li>
    <li>
      <a href="../articles/docker-readme.html">Docker Image</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jcrodriguez1989/rco/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="opt-constant-folding_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Constant Folding</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jcrodriguez1989/rco/blob/master/vignettes/opt-constant-folding.Rmd"><code>vignettes/opt-constant-folding.Rmd</code></a></small>
      <div class="hidden name"><code>opt-constant-folding.Rmd</code></div>

    </div>

    
    
<div id="constant-folding" class="section level1">
<h1 class="hasAnchor">
<a href="#constant-folding" class="anchor"></a>Constant Folding</h1>
<div id="idea" class="section level2">
<h2 class="hasAnchor">
<a href="#idea" class="anchor"></a>Idea</h2>
<p>The basic idea behind this optimizer is to reduce as many calculations as possible. This implies that any expression that can be calculated before running the script, must be calculated and <em>reduced</em> or <em>folded</em> to a single constant value.</p>
</div>
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>Constant folding is an optimization technique that eliminates expressions that calculate a value that can already be determined before code execution. These are typically calculations that only reference constant values or expressions that reference variables whose values are constant.</p>
<p>For example, consider the statement:</p>
<p><code>i &lt;- 320 * 200 * 32</code></p>
<p>Most compilers would not actually generate two multiply instructions. Instead, they identify constructs such as these and substitute the computed values (in this case, <code>2048000</code>). This way, the code will be replaced by:</p>
<p><code>i &lt;- 2048000</code></p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>A simple example would be to have to convert the unit of many temporary samples from hours to miliseconds <code>miliseconds &lt;- 1000 * 60 * 60 * hours</code>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
  <span class="st">"hours_vector &lt;- runif(1000, 0, 24)"</span>,
  <span class="st">"ms_vector &lt;- numeric(1000)"</span>,
  <span class="st">"# of course it would be much efficient to do vectorized operations xP"</span>,
  <span class="st">"for (i in seq_along(hours_vector)) {"</span>,
  <span class="st">"  ms_vector[i] &lt;- 1000 * 60 * 60 * hours_vector[i]"</span>,
  <span class="st">"}"</span>,
  <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"\n"</span>
)
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">code</span>)</pre></body></html></div>
<pre><code>## hours_vector &lt;- runif(1000, 0, 24)
## ms_vector &lt;- numeric(1000)
## # of course it would be much efficient to do vectorized operations xP
## for (i in seq_along(hours_vector)) {
##   ms_vector[i] &lt;- 1000 * 60 * 60 * hours_vector[i]
## }</code></pre>
<p>Then, the automatically optimized code would be:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">opt_code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/opt_constant_folding.html">opt_constant_folding</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">code</span>))
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">opt_code</span>$<span class="no">codes</span><span class="kw">[[</span><span class="fl">1</span>]])</pre></body></html></div>
<pre><code>## hours_vector &lt;- runif(1000, 0, 24)
## ms_vector &lt;- numeric(1000)
## # of course it would be much efficient to do vectorized operations xP
## for (i in seq_along(hours_vector)) {
##   ms_vector[i] &lt;- 3600000 * hours_vector[i]
## }</code></pre>
<p>And if we measure the execution time of each one, and the speed-up:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">bmark_res</span> <span class="kw">&lt;-</span> <span class="fu">microbenchmark</span>({
  <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span>(<span class="kw">text</span> <span class="kw">=</span> <span class="no">code</span>))
}, {
  <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span>(<span class="kw">text</span> <span class="kw">=</span> <span class="no">opt_code</span>))
})
<span class="fu">autoplot</span>(<span class="no">bmark_res</span>)</pre></body></html></div>
<p><img src="opt-constant-folding_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu">speed_up</span>(<span class="no">bmark_res</span>)</pre></body></html></div>
<pre><code>##            Min.  1st Qu.   Median     Mean  3rd Qu.     Max.
## Expr_2 20.57033 20.14685 21.51271 20.11359 23.43132 16.69829</code></pre>
</div>
<div id="implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h2>
<p>Actually, <code>opt_constant_folding</code> will fold expressions that are conformed solely by operators and constants which tokens parsed with <code><a href="https://rdrr.io/r/utils/getParseData.html">utils::getParseData</a></code> function are:</p>
<pre><code>##  [1] "'+'"  "'-'"  "'*'"  "'/'"  "'^'"  "GT"   "GE"   "LT"   "LE"   "EQ"  
## [11] "NE"   "'!'"  "AND"  "OR"   "AND2" "OR2"</code></pre>
<pre><code>## [1] "NUM_CONST"  "STR_CONST"  "NULL_CONST"</code></pre>
<pre><code>## [1] "'('" "')'" "'{'" "'}'"</code></pre>
</div>
<div id="floating-point-precision" class="section level2">
<h2 class="hasAnchor">
<a href="#floating-point-precision" class="anchor"></a>Floating-point precision</h2>
<p>When folding, we can have floating-point precision issues, for instance, consider the following code:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">x</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">2</span> + <span class="fl">1</span>)
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">2</span> + <span class="fl">1</span>)
<span class="no">z</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">2</span> + <span class="fl">1</span>)
<span class="no">x</span> + <span class="no">y</span> + <span class="no">z</span> <span class="kw">==</span> <span class="fl">1</span></pre></body></html></div>
<pre><code>## [1] TRUE</code></pre>
<p>If we fold it, we would have:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
  <span class="st">"x &lt;- 1/(2+1)"</span>,
  <span class="st">"y &lt;- 1/(2+1)"</span>,
  <span class="st">"z &lt;- 1/(2+1)"</span>,
  <span class="st">"x + y + z == 1"</span>,
  <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"\n"</span>
)
<span class="no">opt_code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/opt_constant_folding.html">opt_constant_folding</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">code</span>), <span class="kw">fold_floats</span> <span class="kw">=</span> <span class="fl">TRUE</span>)$<span class="no">codes</span><span class="kw">[[</span><span class="fl">1</span>]]
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">opt_code</span>)</pre></body></html></div>
<pre><code>## x &lt;- 0.333333333333333 
## y &lt;- 0.333333333333333 
## z &lt;- 0.333333333333333 
## x + y + z == 1</code></pre>
<p>However, this code is not equivalent due to precision:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span>(<span class="kw">text</span> <span class="kw">=</span> <span class="no">code</span>))</pre></body></html></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/parse.html">parse</a></span>(<span class="kw">text</span> <span class="kw">=</span> <span class="no">opt_code</span>))</pre></body></html></div>
<pre><code>## [1] FALSE</code></pre>
<p>In this case, we can use the parameter <code>fold_floats</code>. If set to FALSE, then the optimizer will fold every expression except those which will lose precision:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">opt_code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/opt_constant_folding.html">opt_constant_folding</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">code</span>), <span class="kw">fold_floats</span> <span class="kw">=</span> <span class="fl">FALSE</span>)$<span class="no">codes</span><span class="kw">[[</span><span class="fl">1</span>]]
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">opt_code</span>)</pre></body></html></div>
<pre><code>## x &lt;- 1/ 3 
## y &lt;- 1/ 3 
## z &lt;- 1/ 3 
## x + y + z == 1</code></pre>
<p>Consider this example where a sub-expression folding causes precision loss, but as it is not important in overall, then it can be folded:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">opt_code</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/opt_constant_folding.html">opt_constant_folding</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(
  <span class="st">"x &lt;- 1/(2+1)"</span>, <span class="co"># will not fold it because we lose precision</span>
  <span class="st">"y &lt;- 1/(2+1) &gt; 3"</span>, <span class="co"># however, folded or not, it is not &gt; 3, so folds it</span>
  <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"\n"</span>
)), <span class="kw">fold_floats</span> <span class="kw">=</span> <span class="fl">FALSE</span>)$<span class="no">codes</span><span class="kw">[[</span><span class="fl">1</span>]]
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">opt_code</span>)</pre></body></html></div>
<pre><code>## x &lt;- 1/ 3 
## y &lt;- FALSE</code></pre>
</div>
<div id="to-do" class="section level2">
<h2 class="hasAnchor">
<a href="#to-do" class="anchor"></a>To-Do</h2>
<ul>
<li>
<p>Implement intelligent constant folding?</p>
<p>For example: fold <code>0 * x</code> to <code>0</code></p>
<p>However, this could change code semantics, in the second case, if <code>x</code> does not exist then the code would not throw an error, meanwhile, in the first case, it would.</p>
</li>
<li>
<p>Reorder variables with associative operators?</p>
<p>The R parser has left associativity, so <code>x + 10 + 200</code> is <code>((x + 10) + 200)</code>. So this is not being folded to <code>x + 210</code>.</p>
<p>If we consider operators with associativity, we could replace <code>x + 10 + 200</code> to <code>10 + 200 + x</code>, and then fold it to <code>210 + x</code></p>
</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Juan Cruz Rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
